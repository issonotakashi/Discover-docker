- name: Create temporary directories for Docker builds
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /tmp/database
    - /tmp/backend
    - /tmp/httpd

- name: Copy database files to remote server
  copy:
    src: "{{ playbook_dir }}/../database/"
    dest: /tmp/database/
    mode: '0644'

- name: Build database Docker image
  community.docker.docker_image:
    name: discover-docker-database
    tag: latest
    source: build
    force_source: true
    build:
      path: /tmp/database
      pull: true
      nocache: true
    state: present
  vars:
    ansible_python_interpreter: /opt/docker_venv/bin/python

- name: Copy backend files to remote server
  copy:
    src: "{{ playbook_dir }}/../backend-spring/simpleapi/"
    dest: /tmp/backend/
    mode: '0644'

- name: Remove existing backend Docker image
  community.docker.docker_image:
    name: discover-docker-backend
    tag: latest
    state: absent
    force_absent: true
  vars:
    ansible_python_interpreter: /opt/docker_venv/bin/python

- name: Build backend Docker image
  community.docker.docker_image:
    name: discover-docker-backend
    tag: latest
    source: build
    force_source: true
    build:
      path: /tmp/backend
      pull: true
      nocache: true
    state: present
  vars:
    ansible_python_interpreter: /opt/docker_venv/bin/python

- name: Copy HTTPD files to remote server
  copy:
    src: "{{ playbook_dir }}/../httpd/"
    dest: /tmp/httpd/
    mode: '0644'

- name: Build HTTPD Docker image
  community.docker.docker_image:
    name: discover-docker-httpd
    tag: latest
    source: build
    force_source: true
    build:
      path: /tmp/httpd
      pull: true
      nocache: true
    state: present
  vars:
    ansible_python_interpreter: /opt/docker_venv/bin/python
